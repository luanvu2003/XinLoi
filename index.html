<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anh Xin Lỗi Em</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10; /* Đảm bảo UI nằm trên canvas Three.js */
        }

        .main-message {
            position: absolute;
            color: #ff4d6d; /* Màu đỏ hồng */
            font-size: 3.5rem; /* To hơn */
            font-weight: bold;
            text-shadow: 0 0 30px rgba(255, 77, 109, 1), 0 0 60px rgba(255, 77, 109, 0.7); /* Đậm hơn */
            animation: float 5s ease-in-out infinite;
            white-space: nowrap;
            top: 20%; /* Đặt hơi cao hơn */
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.9; }
            50% { transform: translateY(-40px) scale(1.1); opacity: 1; }
        }

        .instruction {
            position: fixed;
            bottom: 20px;
            color: #777; /* Màu xám đậm hơn */
            font-size: 0.9rem;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="main-message">Anh Xin Lỗi Em</div>
        <div class="instruction">Dùng chuột để xoay và cuộn để zoom nhé</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // 1. Setup Scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Composer cho hiệu ứng Bloom
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        composer.addPass(renderPass);

        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.4, 0.85); // Intensity, Radius, Threshold
        composer.addPass(bloomPass);

        // 2. Tạo hình Trái Tim 3D
        let heartMesh;
        function createHeart() {
            const x = 0, y = 0;
            const heartShape = new THREE.Shape();
            heartShape.moveTo( x + 25, y + 25 );
            heartShape.bezierCurveTo( x + 25, y + 25, x + 20, y, x, y );
            heartShape.bezierCurveTo( x - 30, y, x - 30, y + 35,x - 30, y + 35 );
            heartShape.bezierCurveTo( x - 30, y + 55, x - 10, y + 77, x + 25, y + 95 );
            heartShape.bezierCurveTo( x + 60, y + 77, x + 80, y + 55, x + 80, y + 35 );
            heartShape.bezierCurveTo( x + 80, y + 35, x + 80, y, x + 50, y );
            heartShape.bezierCurveTo( x + 35, y, x + 25, y + 25, x + 25, y + 25 );

            const extrudeSettings = { depth: 15, bevelEnabled: true, bevelSegments: 10, steps: 2, bevelSize: 5, bevelThickness: 5 };
            const geometry = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
            geometry.scale(0.15, 0.15, 0.15); // Thu nhỏ trái tim cho vừa màn hình
            geometry.center();

            // Chất liệu PBR (Physically Based Rendering)
            const material = new THREE.MeshStandardMaterial({
                color: 0xff0033, // Đỏ tươi
                emissive: 0x880011, // Ánh sáng phát ra từ vật liệu
                emissiveIntensity: 0.5,
                roughness: 0.2, // Độ nhám thấp, vật liệu bóng
                metalness: 0.7, // Hiệu ứng kim loại
                transparent: true,
                opacity: 0.95
            });
            heartMesh = new THREE.Mesh(geometry, material);
            heartMesh.rotation.z = Math.PI; // Lật ngược lại cho đúng chiều
            scene.add(heartMesh);
        }
        createHeart();

        // 3. Ánh sáng (Lighting) - Nâng cấp
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.3); // Ánh sáng môi trường nhẹ
        scene.add(ambientLight);

        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight1.position.set(20, 30, 20);
        scene.add(directionalLight1);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight2.position.set(-20, -30, -20);
        scene.add(directionalLight2);

        const pointLight = new THREE.PointLight(0xff4d6d, 100, 50); // Điểm sáng màu hồng
        pointLight.position.set(0, 5, 10);
        scene.add(pointLight);

        camera.position.z = 40;

        // 4. Controls (Xoay bằng chuột)
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxDistance = 60;
        controls.minDistance = 20;

        // 5. Chữ rơi từ trên xuống
        const fontLoader = new FontLoader();
        let font;
        fontLoader.load('https://unpkg.com/three@0.160.0/examples/fonts/helvetiker_regular.typeface.json', function (loadedFont) {
            font = loadedFont;
            createFallingText();
        });

        const fallingTexts = [];
        const textOptions = ["Anh Xin Lỗi Em", "Anh Xin Lỗi Em", "Anh Xin Lỗi Em", "Anh Xin Lỗi Em", "Anh Xin Lỗi Em", "Anh Xin Lỗi Em"];
        const textMaterial = new THREE.MeshStandardMaterial({
            color: 0xffaacc, // Màu hồng nhạt
            emissive: 0xaa0033,
            emissiveIntensity: 0.7,
            roughness: 0.1,
            metalness: 0.9,
            transparent: true,
            opacity: 0.8
        });

        function createFallingText() {
            if (!font) return; // Đảm bảo font đã load xong
            for (let i = 0; i < 15; i++) { // Tạo 15 chữ rơi
                const text = textOptions[Math.floor(Math.random() * textOptions.length)];
                const geometry = new TextGeometry(text, {
                    font: font,
                    size: Math.random() * 2 + 0.5, // Kích thước ngẫu nhiên
                    height: 0.2,
                    curveSegments: 5,
                    bevelEnabled: true,
                    bevelThickness: 0.05,
                    bevelSize: 0.02,
                    bevelOffset: 0,
                    bevelSegments: 4
                });
                geometry.center();
                const mesh = new THREE.Mesh(geometry, textMaterial);
                resetTextPosition(mesh);
                fallingTexts.push(mesh);
                scene.add(mesh);
            }
        }

        function resetTextPosition(mesh) {
            mesh.position.x = (Math.random() - 0.5) * 80; // Vị trí X ngẫu nhiên
            mesh.position.y = Math.random() * 50 + 20;   // Bắt đầu từ trên cao
            mesh.position.z = (Math.random() - 0.5) * 60; // Vị trí Z ngẫu nhiên
            mesh.rotation.y = Math.random() * Math.PI * 2;
            mesh.rotation.x = Math.random() * Math.PI * 2;
            mesh.scale.set(1,1,1); // Đảm bảo scale về 1
            mesh.material.opacity = 0.8;
            mesh.userData.speed = Math.random() * 0.1 + 0.05; // Tốc độ rơi ngẫu nhiên
        }

        // 6. Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Xoay nhẹ trái tim
            heartMesh.rotation.y += 0.005;
            
            // Hiệu ứng đập (Pulse) nhẹ hơn
            const scale = 1 + Math.sin(Date.now() * 0.003) * 0.05;
            heartMesh.scale.set(scale, scale, scale);

            // Cập nhật chữ rơi
            fallingTexts.forEach(textMesh => {
                textMesh.position.y -= textMesh.userData.speed;
                textMesh.rotation.y += 0.01; // Xoay nhẹ khi rơi

                if (textMesh.position.y < -30) { // Khi chạm đáy
                    // Hiệu ứng mờ dần trước khi reset
                    if (textMesh.material.opacity > 0) {
                        textMesh.material.opacity -= 0.02; // Giảm opacity
                        textMesh.scale.multiplyScalar(0.98); // Co lại nhẹ
                    } else {
                        resetTextPosition(textMesh);
                    }
                }
            });

            controls.update();
            composer.render(); // Sử dụng composer để render với Bloom
        }

        // Xử lý khi resize màn hình
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
